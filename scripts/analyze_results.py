import argparse
from pathlib import Path
from typing import Iterable

import pandas as pd
import matplotlib.pyplot as plt


METRICS = [
    "time_s",
    "nodes_generated",
    "nodes_expanded",
    "max_frontier",
    "solution_len",
]


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Analyse NPuzzle experiment results and produce summary tables and charts."
    )
    parser.add_argument(
        "csv",
        type=Path,
        help="Path to experiment_results.csv generated by SearchTester.",
    )
    parser.add_argument(
        "--out-dir",
        type=Path,
        default=Path("analysis_results"),
        help="Directory to write summaries and plots (default: ./analysis_results).",
    )
    parser.add_argument(
        "--show",
        action="store_true",
        help="Show plots interactively instead of only saving to files.",
    )
    return parser.parse_args()


def ensure_out_dir(out_dir: Path) -> None:
    out_dir.mkdir(parents=True, exist_ok=True)


def add_status_column(df: pd.DataFrame) -> pd.DataFrame:
    df = df.copy()
    df["status"] = df["solution_len"].apply(lambda v: "solved" if v > 0 else "failed")
    return df


def summarise(df: pd.DataFrame, group_cols: Iterable[str]) -> pd.DataFrame:
    summary = (
        df.groupby(list(group_cols))[METRICS]
        .agg(["count", "mean", "median", "std", "min", "max"])
        .reset_index()
    )
    # flatten multi-level columns
    summary.columns = [
        "_".join(filter(None, map(str, col))).rstrip("_") for col in summary.columns.values
    ]
    return summary


def describe_algorithm_comparison(df: pd.DataFrame, out_dir: Path) -> None:
    print("\n=== A* vs IDA* comparison ===")
    algo_summary = summarise(df, ["algorithm"])
    print(algo_summary)

    fig, axes = plt.subplots(1, 2, figsize=(10, 4))
    algo_order = ["A*", "IDA*"]

    median_time = df.groupby("algorithm")["time_s"].median().reindex(algo_order)
    axes[0].bar(median_time.index, median_time.values, color=["#4C78A8", "#F58518"])
    axes[0].set_title("Median runtime by algorithm")
    axes[0].set_ylabel("time (s)")

    median_nodes = df.groupby("algorithm")["nodes_expanded"].median().reindex(algo_order)
    axes[1].bar(median_nodes.index, median_nodes.values, color=["#4C78A8", "#F58518"])
    axes[1].set_title("Median expanded nodes by algorithm")
    axes[1].set_ylabel("nodes expanded")

    fig.tight_layout()
    output_path = out_dir / "algorithm_comparison.png"
    fig.savefig(output_path, dpi=200)
    print(f"Saved plot -> {output_path}")


HEURISTIC_ORDER = ["MISPLACED", "MANHATTAN", "BLANK_DISTANCE", "DISJOINT_PATTERN"]


def describe_ida_heuristics(df: pd.DataFrame, out_dir: Path) -> None:
    ida_df = df[df["algorithm"] == "IDA*"]
    if ida_df.empty:
        print("No IDA* rows found; skipping heuristic comparison.")
        return

    print("\n=== IDA* heuristic comparison ===")
    heuristic_summary = summarise(ida_df, ["heuristic"])
    heuristic_summary = heuristic_summary.sort_values(
        by="time_s_median", key=lambda col: col.map({h: i for i, h in enumerate(HEURISTIC_ORDER)}).fillna(col)
    )
    print(heuristic_summary)

    ordered_df = ida_df.copy()
    ordered_df["heuristic"] = pd.Categorical(
        ordered_df["heuristic"], categories=HEURISTIC_ORDER, ordered=True
    )
    ordered_df = ordered_df.dropna(subset=["heuristic"])

    fig, axes = plt.subplots(1, 2, figsize=(12, 4))

    axes[0].bar(
        heuristic_summary["heuristic"],
        heuristic_summary["time_s_median"],
        color="#4C78A8",
    )
    axes[0].set_title("IDA*: Median runtime by heuristic")
    axes[0].set_ylabel("time (s)")
    axes[0].tick_params(axis="x", rotation=20)

    axes[1].bar(
        heuristic_summary["heuristic"],
        heuristic_summary["nodes_expanded_median"],
        color="#F58518",
    )
    axes[1].set_title("IDA*: Median expanded nodes by heuristic")
    axes[1].set_ylabel("nodes expanded")
    axes[1].tick_params(axis="x", rotation=20)

    fig.tight_layout()
    output_path = out_dir / "ida_heuristic_comparison.png"
    fig.savefig(output_path, dpi=200)
    print(f"Saved plot -> {output_path}")


def main() -> None:
    args = parse_args()
    ensure_out_dir(args.out_dir)

    df = pd.read_csv(args.csv)
    expected_columns = {
        "algorithm",
        "heuristic",
        "time_s",
        "nodes_generated",
        "nodes_expanded",
        "max_frontier",
        "solution_len",
    }
    missing = expected_columns - set(df.columns)
    if missing:
        raise ValueError(f"Missing columns in CSV: {missing}")

    df = add_status_column(df)

    describe_algorithm_comparison(df, args.out_dir)
    describe_ida_heuristics(df, args.out_dir)

    if args.show:
        plt.show()
    else:
        plt.close("all")


if __name__ == "__main__":
    main()
